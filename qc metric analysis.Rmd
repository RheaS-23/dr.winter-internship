---
title: "qc metric analysis"
author: "rhea shah"
date: "2023-07-11"
output: html_document
---

```{r}

library(dplyr)
library(Seurat)
library(patchwork)
library(hdf5r)
library(ggplot2)
library(magrittr)

# ================= rhea - eyeballing based on distribution =================

# ----------------------- loading in the data -----------------------
# loading the data
hce048_obj <- Read10X_h5(filename = "~/2023 sir/single cell analysis/hce048_distal_filteredfeaturematrix.h5")

# creating the seurat object
hce048_obj <- CreateSeuratObject(counts = hce048_obj)

# importing the hce048 proximal data
hce048_proximal_obj <- Read10X_h5(filename = "~/2023 sir/single cell analysis/hce048_proximal_filteredfeaturematrix.h5")

# creating the seurat object
hce048_proximal_obj <- CreateSeuratObject(counts = hce048_proximal_obj)

# importing the iw0076 distal data
iw0076_distal_obj <- Read10X_h5(filename = "~/2023 sir/single cell analysis/iw0076_distal_filteredfeaturematrix.h5")

# creating the seurat object
iw0076_distal_obj <- CreateSeuratObject(counts = iw0076_distal_obj)

# importing the iw0076 proximal data
iw0076_proximal_obj <- Read10X_h5(filename = "~/2023 sir/single cell analysis/iw0076_proximal_filteredfeaturematrix.h5")

# creating the seurat object
iw0076_proximal_obj <- CreateSeuratObject(counts = iw0076_proximal_obj)

# importing the p0630 distal data
p0630_distal_obj <- Read10X_h5(filename = "~/2023 sir/single cell analysis/p0630_distal_filteredfeaturematrix.h5")

# creating the seurat object
p0630_distal_obj <- CreateSeuratObject(counts = p0630_distal_obj)

# importing the p0630 proximal data
p0630_proximal_obj <- Read10X_h5(filename = "~/2023 sir/single cell analysis/p0630_proximal_filteredfeaturematrix.h5")

# creating the seurat object
p0630_proximal_obj <- CreateSeuratObject(counts = p0630_proximal_obj)


# ------------------------- FOR LOOP ----------------------------------------

sample_list <- list(hce048_obj, hce048_proximal_obj, iw0076_distal_obj, iw0076_proximal_obj, p0630_distal_obj, p0630_proximal_obj)  

for (object in sample_list) {
   # adding number of genes per umi for each cell to the metadata
   object$log10GenesPerUmi <- log10(object$nFeature_RNA + 1) / log10(object$nCount_RNA + 1)  # Adding 1 to avoid division by zero
   
   # adding the percent.mt RATIO (why we divide by 100)
   object$mitoRatio <- PercentageFeatureSet(object = object, pattern = "^MT-")
   object$mitoRatio <- object$mitoRatio / 100  # Access the mitoRatio column directly
   
   # creating the meta data dataframe
   metadata <- object@meta.data  # Access the meta.data slot of the object
   
   # adding cell ids to the metadata
   metadata$cells <- rownames(metadata)
   
   # renaming some of the columns
   metadata <- metadata %>%
     rename(seq_folder = orig.ident,
            nUMI = nCount_RNA,
            nGene = nFeature_RNA)
   
   # creating another column to group the cells together to make it easier to visualize
   metadata$sample <- "cell"
   
   # adding the metadata back into the seurat object
   object@meta.data <- metadata
   
   # visualizing the number of cell counts
   cell_counts <- metadata %>%
     ggplot(aes(x = sample)) +
     geom_bar() +
     theme_classic() +
     theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
     theme(plot.title = element_text(hjust=0.5, face="bold")) +
     ggtitle("nCells")
   
   # visualizing umi's per cell
   umi_per_cell <- metadata %>%
     ggplot(aes(color=sample, x=nUMI, fill= sample)) +
     geom_density(alpha = 0.2) +
     scale_x_log10() +
     theme_classic() +
     ylab("Cell density") +
     geom_vline(xintercept = 50)
   
   # Visualize the distribution of genes detected per cell via histogram
   genes_per_cell_hist <- metadata %>%
     ggplot(aes(color=sample, x=nGene, fill= sample)) +
     geom_density(alpha = 0.2) +
     theme_classic() +
     scale_x_log10() +
     geom_vline(xintercept = 300)
   
   # Visualize the distribution of genes detected per cell via boxplot
   genes_per_cell_box <- metadata %>%
     ggplot(aes(x=sample, y=log10(nGene), fill=sample)) +
     geom_boxplot() +
     theme_classic() +
     theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
     theme(plot.title = element_text(hjust=0.5, face="bold")) +
     ggtitle("NCells vs NGenes")
   
   # Visualize the correlation between genes detected and number of UMIs and determine whether strong presence of cells with low numbers of genes/UMIs
   gene_and_umi <- metadata %>%
     ggplot(aes(x=nUMI, y=nGene, color=mitoRatio)) +
     geom_point() +
     scale_colour_gradient(low = "gray90", high = "black") +
     stat_smooth(method=lm) +
     scale_x_log10() +
     scale_y_log10() +
     theme_classic() +
     geom_vline(xintercept = 500) +
     geom_hline(yintercept = 250) +
     facet_wrap(~sample)
   
   # Visualize the distribution of mitochondrial gene expression detected per cell
   mito_expression <- metadata %>%
     ggplot(aes(color=sample, x=mitoRatio, fill=sample)) +
     geom_density(alpha = 0.2) +
     scale_x_log10() +
     theme_classic() +
     geom_vline(xintercept = 0.2)
   
   # Visualize the overall complexity of the gene expression by visualizing the genes detected per UMI
   gene_per_umi <- metadata %>%
     ggplot(aes(x=log10GenesPerUmi, color = sample, fill=sample)) +
     geom_density(alpha = 0.2) +
     theme_classic() +
     geom_vline(xintercept = 0.8)
   
   #outputting the various graphs
   print(cell_counts)
   print(gene_per_umi)
   print(umi_per_cell)
   print(mito_expression)
   print(gene_and_umi)
   print(genes_per_cell_box)
   print(genes_per_cell_hist)
}

# --------------------------- creating the subsets ------------------------------

# creating a subset of the hce048 distal data
filtered_hce048sample <- subset(hce048_obj@meta.data, subset = (nGene >= 250) & (mitoRatio < 0.2) & (log10GenesPerUmi > 0.75) & (nUMI > 750))

# creating a subset of hce048 proximal data 
filtered_hce048proximalsample <- subset(hce048_proximal_obj, subset = (nUMI > 750) & (nGene >= 500) & (mitoRatio < 0.2) & (log10GenesPerUmi > 0.7))

# subset for the iw0076 distal data 
filtered_iw0076distalsample <- subset(iw0076_distal_obj, subset = (nUMI > 500) & (nGene >= 750) & (mitoRatio < 0.2) & (log10GenesPerUmi > 0.7))

# subset for the iw0076 proximal data 
filtered_iw0076proximalsample <- subset(iw0076_proximal_obj, subset = (nUMI > 500) & (nGene >= 500) & (mitoRatio < 0.2) & (log10GenesPerUmi > 0.7))

# subset for p0630 distal data
filtered_p0630distalsample <- subset(p0630_distal_obj, subset = (nUMI > 500) & (nGene >= 500) & (mitoRatio < 0.2) & (log10GenesPerUmi > 0.7))

# subset for p0630 proximal data 
filtered_p0630proximalsample <- subset(p0630_proximal_obj, subset = (nUMI > 750) & (nGene >= 300) & (mitoRatio < 0.2) & (log10GenesPerUmi > 0.75))


# ================= ankitha - relative to median =================

# ================= himani - absolute value =================

library(dplyr)
library(Seurat)
library(patchwork)
library(hdf5r)

# Load the data
obj.data <- Read10X_h5("C:/Users/Himani/Downloads/matrix.h5")

# Create the seurat object
seurat_obj <- CreateSeuratObject(counts = obj.data, min.cells = 3, min.features = 200)

# visualizing the object before the QC strategy using a Vln Plot
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^MT-")
VlnPlot(seurat_obj, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), pt.size = 0.01, ncol = 3)

# Scatterplot of total counts vs. number of expressed genes
FeatureScatter(seurat_obj, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")

#using absolute value QC strategy (identifying & removing low-quality cells)

# Define cutoff values
count_cutoff <- 4000
gene_cutoff <- 3000

# Filter cells based on cutoffs
seurat_obj <- subset(seurat_obj, subset = nCount_RNA > count_cutoff)

# Filter cells by gene
seurat_obj <- subset(seurat_obj, subset = nFeature_RNA > gene_cutoff)

#updating the seurat object
updated_seurat <- UpdateSeuratObject(seurat_obj)

#visualizing it after the changes
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "^MT-")
VlnPlot(seurat_obj, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), pt.size = 0.01, ncol = 3)

# ================= anjali - percentile =================  



```